import random
from decimal import Decimal
from io import BytesIO

from django.core.management.base import BaseCommand
from django.core.files.base import ContentFile
from django.db import transaction
from django.utils.translation import gettext as _
from PIL import Image, ImageDraw, ImageFont

from core.models import Category
from recipes.models import Recipe, Ingredient, RecipeIngredient


SAMPLE_CATEGORIES = [
    "–í–µ–≥–∞–Ω", "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞", "–≠–∫–æ–Ω–æ–º", "–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ", "–ë—ã—Å—Ç—Ä–æ–µ"
]

SAMPLE_INGREDIENTS = [
    ("–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å",     "pcs", Decimal("10.00")),
    ("–ú–æ—Ä–∫–æ–≤—å",       "pcs", Decimal("5.00")),
    ("–õ—É–∫",           "pcs", Decimal("3.00")),
    ("–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ",  "g",   Decimal("0.20")),
    ("–†–∏—Å",           "g",   Decimal("0.05")),
    ("–ì—Ä–∏–±—ã",         "g",   Decimal("0.15")),
    ("–¢–≤–æ—Ä–æ–≥",        "g",   Decimal("0.12")),
    ("–ú—É–∫–∞",          "g",   Decimal("0.02")),
]

COMMAND_EXAMPLES = [
    {
        "title": "–ë—ã—Å—Ç—Ä—ã–π –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–π —Å—É–ø",
        "categories": ["–ë—ã—Å—Ç—Ä–æ–µ", "–≠–∫–æ–Ω–æ–º"],
        "instructions": (
            "1. –û—á–∏—Å—Ç–∏—Ç—å –∏ –Ω–∞—Ä–µ–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å –∏ –ª—É–∫.\n"
            "2. –ó–∞–ª–∏—Ç—å –æ–≤–æ—â–∏ –≤–æ–¥–æ–π, –¥–æ–≤–µ—Å—Ç–∏ –¥–æ –∫–∏–ø–µ–Ω–∏—è.\n"
            "3. –í–∞—Ä–∏—Ç—å 10‚Äì15 –º–∏–Ω—É—Ç –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.\n"
            "4. –ü–æ—Å–æ–ª–∏—Ç—å, –ø–æ–ø–µ—Ä—á–∏—Ç—å –ø–æ –≤–∫—É—Å—É –∏ –ø–æ–¥–∞–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–º."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 5, "unit": "pcs"},
            {"name": "–ú–æ—Ä–∫–æ–≤—å",   "amount": 1, "unit": "pcs"},
            {"name": "–õ—É–∫",       "amount": 1, "unit": "pcs"},
        ],
    },
    {
        "title": "–ì—Ä–∏–±–Ω–æ–µ —Ä–∏–∑–æ—Ç—Ç–æ",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ"],
        "instructions": (
            "1. –ù–∞ —Å–∫–æ–≤–æ—Ä–æ–¥–µ –æ–±–∂–∞—Ä–∏—Ç—å –ª—É–∫ –¥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å –∏ —Å–ª–µ–≥–∫–∞ –æ–±–∂–∞—Ä–∏—Ç—å.\n"
            "3. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –≤–ª–∏–≤–∞—Ç—å –≥–æ—Ä—è—á—É—é –≤–æ–¥—É, –ø–æ–º–µ—à–∏–≤–∞—è, –ø–æ–∫–∞ —Ä–∏—Å –Ω–µ —Å—Ç–∞–Ω–µ—Ç –∫—Ä–µ–º–æ–≤—ã–º.\n"
            "4. –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∏–±—ã, –ø–µ—Ä–µ–º–µ—à–∞—Ç—å –∏ —Å–Ω—è—Ç—å —Å –æ–≥–Ω—è."
        ),
        "ingredients": [
            {"name": "–†–∏—Å",   "amount": 200, "unit": "g"},
            {"name": "–ì—Ä–∏–±—ã", "amount": 150, "unit": "g"},
            {"name": "–õ—É–∫",   "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–ú–æ—Ä–∫–æ–≤–Ω—ã–π —Å–∞–ª–∞—Ç",
        "categories": ["–í–µ–≥–∞–Ω", "–≠–∫–æ–Ω–æ–º", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –ù–∞—Ç–µ—Ä–µ—Ç—å –º–æ—Ä–∫–æ–≤—å –Ω–∞ –∫—Ä—É–ø–Ω–æ–π —Ç—ë—Ä–∫–µ.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å –º–µ–ª–∫–æ –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π –ª—É–∫.\n"
            "3. –ó–∞–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã–º –º–∞—Å–ª–æ–º, –ø–æ—Å–æ–ª–∏—Ç—å –∏ –ø–µ—Ä–µ–º–µ—à–∞—Ç—å."
        ),
        "ingredients": [
            {"name": "–ú–æ—Ä–∫–æ–≤—å", "amount": 3, "unit": "pcs"},
            {"name": "–õ—É–∫",     "amount": 1, "unit": "pcs"},
        ],
    },
    {
        "title": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω–æ–µ –ø—é—Ä–µ",
        "categories": ["–≠–∫–æ–Ω–æ–º", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –û—Ç–≤–∞—Ä–∏—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –¥–æ –º—è–≥–∫–æ—Å—Ç–∏.\n"
            "2. –°–ª–∏—Ç—å –≤–æ–¥—É, —Ä–∞—Å—Ç–æ–ª–æ—á—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å.\n"
            "3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∂–∞—Ä–µ–Ω–Ω—ã–π –ª—É–∫, –ø–æ—Å–æ–ª–∏—Ç—å, –ø–µ—Ä–µ–º–µ—à–∞—Ç—å."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 4, "unit": "pcs"},
            {"name": "–õ—É–∫",       "amount": 1, "unit": "pcs"},
        ],
    },
    {
        "title": "–û–≤–æ—â–Ω–æ–µ —Ä–∞–≥—É",
        "categories": ["–í–µ–≥–∞–Ω", "–≠–∫–æ–Ω–æ–º"],
        "instructions": (
            "1. –ù–∞—Ä–µ–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å, –º–æ—Ä–∫–æ–≤—å, –≥—Ä–∏–±—ã –∏ –ª—É–∫.\n"
            "2. –í —Å–æ—Ç–µ–π–Ω–∏–∫–µ –æ–±–∂–∞—Ä–∏—Ç—å –ª—É–∫, –¥–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–≤–æ—â–∏.\n"
            "3. –¢—É—à–∏—Ç—å –ø–æ–¥ –∫—Ä—ã—à–∫–æ–π 15‚Äì20 –º–∏–Ω—É—Ç, –ø–æ—Å–æ–ª–∏—Ç—å."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 2,   "unit": "pcs"},
            {"name": "–ú–æ—Ä–∫–æ–≤—å",   "amount": 2,   "unit": "pcs"},
            {"name": "–ì—Ä–∏–±—ã",     "amount": 100, "unit": "g"},
            {"name": "–õ—É–∫",       "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–†–∏—Å–æ–≤–∞—è –∫–∞—à–∞",
        "categories": ["–≠–∫–æ–Ω–æ–º"],
        "instructions": (
            "1. –ü—Ä–æ–º—ã—Ç—å —Ä–∏—Å.\n"
            "2. –°–≤–∞—Ä–∏—Ç—å —Ä–∏—Å –≤ –≤–æ–¥–µ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, –ø–æ—Å–æ–ª–∏—Ç—å –ø–æ –≤–∫—É—Å—É.\n"
            "3. –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ."
        ),
        "ingredients": [
            {"name": "–†–∏—Å", "amount": 150, "unit": "g"},
        ],
    },
    {
        "title": "–ö—É—Ä–∏–Ω—ã–π –ø–ª–æ–≤",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ"],
        "instructions": (
            "1. –û–±–∂–∞—Ä–∏—Ç—å –ª—É–∫ –∏ –º–æ—Ä–∫–æ–≤—å –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å –∏ –∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ, –∑–∞–ª–∏—Ç—å –≤–æ–¥–æ–π.\n"
            "3. –¢—É—à–∏—Ç—å –ø–æ–¥ –∫—Ä—ã—à–∫–æ–π 20‚Äì25 –º–∏–Ω—É—Ç, –ø–æ—Å–æ–ª–∏—Ç—å."
        ),
        "ingredients": [
            {"name": "–†–∏—Å",          "amount": 200, "unit": "g"},
            {"name": "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", "amount": 200, "unit": "g"},
            {"name": "–õ—É–∫",          "amount": 1,   "unit": "pcs"},
            {"name": "–ú–æ—Ä–∫–æ–≤—å",      "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–ì—Ä–∏–±–Ω–æ–µ —Å–æ—Ç–µ",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –ù–∞—Ä–µ–∑–∞—Ç—å –≥—Ä–∏–±—ã –∏ –ª—É–∫.\n"
            "2. –û–±–∂–∞—Ä–∏—Ç—å –ª—É–∫, –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∏–±—ã –∏ –≥–æ—Ç–æ–≤–∏—Ç—å 5‚Äì7 –º–∏–Ω—É—Ç.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–º."
        ),
        "ingredients": [
            {"name": "–ì—Ä–∏–±—ã", "amount": 200, "unit": "g"},
            {"name": "–õ—É–∫",   "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–¢–≤–æ—Ä–æ–∂–Ω—ã–µ –æ–ª–∞–¥—å–∏",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ"],
        "instructions": (
            "1. –°–º–µ—à–∞—Ç—å —Ç–≤–æ—Ä–æ–≥ —Å –º—É–∫–æ–π –¥–æ –æ–¥–Ω–æ—Ä–æ–¥–Ω–æ—Å—Ç–∏.\n"
            "2. –°–º–∞–∂—å—Ç–µ —Å–∫–æ–≤–æ—Ä–æ–¥—É –º–∞—Å–ª–æ–º, –≤—ã–ø–µ–∫–∞–π—Ç–µ –æ–ª–∞–¥—å–∏ –ø–æ 2 –º–∏–Ω—É—Ç—ã —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã."
        ),
        "ingredients": [
            {"name": "–¢–≤–æ—Ä–æ–≥", "amount": 200, "unit": "g"},
            {"name": "–ú—É–∫–∞",   "amount": 50,  "unit": "g"},
        ],
    },
    {
        "title": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å–Ω—ã–µ –æ–ª–∞–¥—å–∏",
        "categories": ["–≠–∫–æ–Ω–æ–º", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –ù–∞—Ç–µ—Ä–µ—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –∏ –ª—É–∫, –æ—Ç–∂–∞—Ç—å –ª–∏—à–Ω–∏–π —Å–æ–∫.\n"
            "2. –°–º–µ—à–∞—Ç—å —Å –º—É–∫–æ–π –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–ª–∞–¥—å–∏.\n"
            "3. –û–±–∂–∞—Ä–∏—Ç—å –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–π –∫–æ—Ä–æ—á–∫–∏."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 3,  "unit": "pcs"},
            {"name": "–ú—É–∫–∞",      "amount": 50, "unit": "g"},
            {"name": "–õ—É–∫",       "amount": 1,  "unit": "pcs"},
        ],
    },
    {
        "title": "–†–∏—Å —Å –≥—Ä–∏–±–∞–º–∏",
        "categories": ["–≠–∫–æ–Ω–æ–º", "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"],
        "instructions": (
            "1. –û–±–∂–∞—Ä–∏—Ç—å –≥—Ä–∏–±—ã –∏ –ª—É–∫.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å, –∑–∞–ª–∏—Ç—å –≤–æ–¥–æ–π –∏ –≤–∞—Ä–∏—Ç—å –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å."
        ),
        "ingredients": [
            {"name": "–†–∏—Å",   "amount": 150, "unit": "g"},
            {"name": "–ì—Ä–∏–±—ã", "amount": 100, "unit": "g"},
        ],
    },
    {
        "title": "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ —Å –≥—Ä–∏–±–∞–º–∏",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ", "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"],
        "instructions": (
            "1. –û–±–∂–∞—Ä–∏—Ç—å –∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∏–±—ã –∏ –≥–æ—Ç–æ–≤–∏—Ç—å –µ—â—ë 5‚Äì7 –º–∏–Ω—É—Ç.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å —Å –≥–∞—Ä–Ω–∏—Ä–æ–º."
        ),
        "ingredients": [
            {"name": "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", "amount": 200, "unit": "g"},
            {"name": "–ì—Ä–∏–±—ã",        "amount": 150, "unit": "g"},
        ],
    },
    {
        "title": "–ü–æ—Å—Ç–Ω—ã–π —Å—É–ø",
        "categories": ["–í–µ–≥–∞–Ω", "–≠–∫–æ–Ω–æ–º"],
        "instructions": (
            "1. –ù–∞—Ä–µ–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –∏ –º–æ—Ä–∫–æ–≤—å.\n"
            "2. –í—Å–∫–∏–ø—è—Ç–∏—Ç—å –≤–æ–¥—É, –¥–æ–±–∞–≤–∏—Ç—å –æ–≤–æ—â–∏ –∏ –≤–∞—Ä–∏—Ç—å 10‚Äì15 –º–∏–Ω—É—Ç.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–º."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 3, "unit": "pcs"},
            {"name": "–ú–æ—Ä–∫–æ–≤—å",   "amount": 2, "unit": "pcs"},
        ],
    },
    {
        "title": "–ë—ã—Å—Ç—Ä—ã–π –≥–∞—Ä–Ω–∏—Ä –∏–∑ –º–æ—Ä–∫–æ–≤–∏",
        "categories": ["–ë—ã—Å—Ç—Ä–æ–µ", "–≠–∫–æ–Ω–æ–º"],
        "instructions": (
            "1. –ú–æ—Ä–∫–æ–≤—å –Ω–∞—Ä–µ–∑–∞—Ç—å –±—Ä—É—Å–∫–∞–º–∏ –∏ –æ–±–∂–∞—Ä–∏—Ç—å 5 –º–∏–Ω—É—Ç.\n"
            "2. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å –∫–∞–∫ –≥–∞—Ä–Ω–∏—Ä."
        ),
        "ingredients": [
            {"name": "–ú–æ—Ä–∫–æ–≤—å", "amount": 3, "unit": "pcs"},
        ],
    },
    {
        "title": "–ì—Ä–∏–±–Ω–æ–π —Å—É–ø",
        "categories": ["–≠–∫–æ–Ω–æ–º", "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"],
        "instructions": (
            "1. –ù–∞—Ä–µ–∑–∞—Ç—å –≥—Ä–∏–±—ã, –ª—É–∫ –∏ –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å.\n"
            "2. –û—Ç–≤–∞—Ä–∏—Ç—å –æ–≤–æ—â–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, –¥–æ–±–∞–≤–∏—Ç—å –≥—Ä–∏–±—ã –∑–∞ 5 –º–∏–Ω—É—Ç –¥–æ –∫–æ–Ω—Ü–∞.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å."
        ),
        "ingredients": [
            {"name": "–ì—Ä–∏–±—ã",     "amount": 150, "unit": "g"},
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 2,   "unit": "pcs"},
            {"name": "–õ—É–∫",       "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–ö—É—Ä–∏–Ω—ã–π –±—É–ª—å–æ–Ω",
        "categories": ["–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞"],
        "instructions": (
            "1. –ó–∞–ª–∏—Ç—å –∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ –≤–æ–¥–æ–π –∏ –¥–æ–≤–µ—Å—Ç–∏ –¥–æ –∫–∏–ø–µ–Ω–∏—è.\n"
            "2. –í–∞—Ä–∏—Ç—å 20‚Äì25 –º–∏–Ω—É—Ç, —É–±—Ä–∞—Ç—å –ø–µ–Ω—É, –ø–æ—Å–æ–ª–∏—Ç—å.\n"
            "3. –ü–æ–¥–∞–≤–∞—Ç—å —Å –∑–µ–ª–µ–Ω—å—é."
        ),
        "ingredients": [
            {"name": "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", "amount": 300, "unit": "g"},
            {"name": "–õ—É–∫",           "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–†–∏—Å–æ–≤—ã–π –ø–ª–æ–≤",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ"],
        "instructions": (
            "1. –û–±–∂–∞—Ä–∏—Ç—å –º–æ—Ä–∫–æ–≤—å –∏ –ª—É–∫ –¥–æ –º—è–≥–∫–æ—Å—Ç–∏.\n"
            "2. –î–æ–±–∞–≤–∏—Ç—å —Ä–∏—Å, –∑–∞–ª–∏—Ç—å –≤–æ–¥–æ–π –∏ —Ç—É—à–∏—Ç—å 20 –º–∏–Ω—É—Ç.\n"
            "3. –ü–æ—Å–æ–ª–∏—Ç—å –∏ –ø–æ–¥–∞–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–º."
        ),
        "ingredients": [
            {"name": "–†–∏—Å",      "amount": 200, "unit": "g"},
            {"name": "–ú–æ—Ä–∫–æ–≤—å",  "amount": 1,   "unit": "pcs"},
            {"name": "–õ—É–∫",      "amount": 1,   "unit": "pcs"},
        ],
    },
    {
        "title": "–¢–≤–æ—Ä–æ–∂–Ω–∞—è –∑–∞–ø–µ–∫–∞–Ω–∫–∞",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ"],
        "instructions": (
            "1. –°–º–µ—à–∞—Ç—å —Ç–≤–æ—Ä–æ–≥ —Å –º—É–∫–æ–π –¥–æ –ø–∞—Å—Ç—ã.\n"
            "2. –í—ã–ª–æ–∂–∏—Ç—å –≤ —Ñ–æ—Ä–º—É –∏ –∑–∞–ø–µ—á—å –ø—Ä–∏ 180¬∞C 25‚Äì30 –º–∏–Ω—É—Ç."
        ),
        "ingredients": [
            {"name": "–¢–≤–æ—Ä–æ–≥", "amount": 300, "unit": "g"},
            {"name": "–ú—É–∫–∞",   "amount": 50,  "unit": "g"},
        ],
    },
    {
        "title": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –≤–æ —Ñ—Ä–∏—Ç—é—Ä–µ",
        "categories": ["–≠–∫–æ–Ω–æ–º", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –ù–∞—Ä–µ–∑–∞—Ç—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –ª–æ–º—Ç–∏–∫–∞–º–∏.\n"
            "2. –û–±–∂–∞—Ä–∏—Ç—å –≤–æ —Ñ—Ä–∏—Ç—é—Ä–µ –∏–ª–∏ –≤ –≥–ª—É–±–æ–∫–æ–π –∫–∞—Å—Ç—Ä—é–ª–µ —Å –º–∞—Å–ª–æ–º –¥–æ —Ö—Ä—É—Å—Ç—è—â–µ–π –∫–æ—Ä–æ—á–∫–∏."
        ),
        "ingredients": [
            {"name": "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "amount": 4, "unit": "pcs"},
        ],
    },
    {
        "title": "–ö—É—Ä–∏–Ω–æ-—Ä–∏—Å–æ–≤—ã–π —Å–∞–ª–∞—Ç",
        "categories": ["–ü—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–µ", "–ë–µ–∑ –≥–ª—é—Ç–µ–Ω–∞", "–ë—ã—Å—Ç—Ä–æ–µ"],
        "instructions": (
            "1. –û—Ç–≤–∞—Ä–∏—Ç—å –∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ –∏ —Ä–∏—Å, –æ—Å—Ç—É–¥–∏—Ç—å.\n"
            "2. –ù–∞—Ä–µ–∑–∞—Ç—å —Ñ–∏–ª–µ –∫—É–±–∏–∫–∞–º–∏ –∏ —Å–º–µ—à–∞—Ç—å —Å —Ä–∏—Å–æ–º.\n"
            "3. –î–æ–±–∞–≤–∏—Ç—å –º–µ–ª–∫–æ –Ω–∞—Ä–µ–∑–∞–Ω–Ω—ã–π –ª—É–∫, –∑–∞–ø—Ä–∞–≤–∏—Ç—å –º–∞—Å–ª–æ–º –∏ –ø–æ—Å–æ–ª–∏—Ç—å."
        ),
        "ingredients": [
            {"name": "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", "amount": 150, "unit": "g"},
            {"name": "–†–∏—Å",           "amount": 100, "unit": "g"},
            {"name": "–õ—É–∫",           "amount": 1,   "unit": "pcs"},
        ],
    },
]

class Command(BaseCommand):
    help = _("–ó–∞–ø–æ–ª–Ω—è–µ—Ç –±–∞–∑—É —Ç–µ—Å—Ç–æ–≤—ã–º–∏ —Ä–µ—Ü–µ–ø—Ç–∞–º–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏, –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –∏ placeholder-–∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏")

    @transaction.atomic
    def handle(self, *args, **options):
        self.stdout.write(_("–°–æ–∑–¥–∞—ë–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π‚Ä¶"))
        category_objs = {
            name: Category.objects.get_or_create(name=name)[0]
            for name in SAMPLE_CATEGORIES
        }

        self.stdout.write(_("–°–æ–∑–¥–∞—ë–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤‚Ä¶"))
        for name, _, _ in SAMPLE_INGREDIENTS:
            Ingredient.objects.get_or_create(name=name)
        cost_map = {(n, u): c for n, u, c in SAMPLE_INGREDIENTS}

        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–π —à—Ä–∏—Ñ—Ç, –∏–Ω–∞—á–µ –¥–µ—Ñ–æ–ª—Ç
        try:
            font = ImageFont.truetype("/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf", size=24)
        except IOError:
            font = ImageFont.load_default()

        self.stdout.write(_("üçΩ –°—Ç–∞–¥–∏–º —Ä–µ—Ü–µ–ø—Ç—ã‚Ä¶"))
        for data in COMMAND_EXAMPLES:
            title = data["title"]
            instr = data["instructions"]
            cats  = [category_objs[n] for n in data["categories"]]

            rec, created = Recipe.objects.get_or_create(
                title=title,
                defaults={"estimated_cost": Decimal("0.00"), "instructions": instr}
            )
            # –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
            if not created and rec.instructions != instr:
                rec.instructions = instr
                rec.save(update_fields=["instructions"])

            rec.categories.set(cats)

            # —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–µ
            RecipeIngredient.objects.filter(recipe=rec).delete()
            total = Decimal("0.00")
            for item in data["ingredients"]:
                ing_obj = Ingredient.objects.get(name=item["name"])
                amount  = Decimal(str(item["amount"]))
                cost    = cost_map[(item["name"], item["unit"])]
                RecipeIngredient.objects.create(
                    recipe=rec,
                    ingredient=ing_obj,
                    amount=amount,
                    unit=item["unit"],
                    unit_cost=cost
                )
                total += amount * cost

            # —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            rec.estimated_cost = total
            rec.save(update_fields=["estimated_cost"])

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º placeholder-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –ø–æ–¥ –∏–º–µ–Ω–µ–º "<pk>.jpg"
            buf = BytesIO()
            img = Image.new("RGB", (600, 400), (230, 230, 230))
            draw = ImageDraw.Draw(img)
            bbox = draw.textbbox((0, 0), title, font=font)
            w, h = bbox[2] - bbox[0], bbox[3] - bbox[1]
            draw.text(
                ((600 - w) / 2, (400 - h) / 2),
                title,
                fill=(30, 30, 30),
                font=font
            )
            img.save(buf, format="JPEG", quality=80)
            # –∏–º—è —Ñ–∞–π–ª–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏
            filename = f"{rec.pk}.jpg"
            rec.image.save(filename, ContentFile(buf.getvalue()), save=True)

            self.stdout.write(f"  ‚Ä¢ {title} ‚Üí {total}‚ÇΩ")

        self.stdout.write(self.style.SUCCESS(_("‚úÖ –í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã —Å–æ–∑–¥–∞–Ω—ã")))
